<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Compare Plate to recommended and reality</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --plate-wrapper-size: 520px;
            --plate-diameter: 480px;
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto;
            margin: 14px;
            background: #f6f6f7;
            color: #222
        }

        .page {
            max-width: 1200px;
            margin: 0 auto
        }

        .topbar {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #bbb;
            background: #fff;
            cursor: pointer
        }

        .panels {
            display: flex;
            flex-direction: column;
            gap: 28px;
            padding-bottom: 120px
        }

        .panel {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 6px 22px rgba(0, 0, 0, 0.06)
        }

        .panelHeader {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px
        }

        .panelTitle {
            font-weight: 600
        }

        .canvasRow {
            display: flex;
            gap: 18px;
            align-items: flex-start
        }

        .plateCanvas {
            position: relative;
            width: var(--plate-wrapper-size);
            height: var(--plate-wrapper-size);
            background: #fff6e6;
            border: 8px solid #eee;
            overflow: visible;
            padding: 0;
            box-sizing: border-box;
            border-radius: 50%;
            aspect-ratio: 1/1;
        }

        .layer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            box-sizing: border-box
        }

        .sideColumn {
            position: absolute;
            top: 14px;
            right: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none
        }

        .sideColumn.left {
            right: auto;
            left: 18px
        }

        .sideItem {
            width: 86px;
            height: 86px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .plateWrap {
            position: absolute;
            left: 50%;
            top: 50%;
            width: var(--plate-diameter);
            height: var(--plate-diameter);
            transform: translate(-50%, -50%) scale(1);
            transform-origin: 50% 50%;
            border-radius: 50%;
            pointer-events: none;
            box-sizing: border-box;
            aspect-ratio: 1/1;
        }

        .plateInner {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .ghostGroup,
        .scaledGroup,
        .ghostInnerGroup {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            transform-origin: 50% 50%;
            pointer-events: none;
            overflow: visible;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .ghostGroup {
            z-index: 8;
        }

        .scaledGroup {
            z-index: 10;
        }

        .ghostInnerGroup {
            z-index: 12;
        }

        .overlayFill {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            pointer-events: none;
            box-sizing: border-box;
        }

        .itemWrapper {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none
        }

        .itemWrapper img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 220ms ease
        }

        .ghost-img {
            filter: grayscale(100%) contrast(78%);
            opacity: 0.55
        }

        .ghost-inner-img {
            filter: grayscale(100%) contrast(78%);
            opacity: 0.95
        }

        .scaled-img {
            filter: none;
            opacity: 1
        }

        .clip-half-left {
            -webkit-clip-path: inset(0 50% 0 0);
            clip-path: inset(0 50% 0 0);
        }

        .clip-half-right {
            -webkit-clip-path: inset(0 0 0 50%);
            clip-path: inset(0 0 0 50%);
        }

        .caption {
            font-size: 13px;
            color: #333;
            margin-top: 8px;
            max-width: 420px
        }

        .annulus {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.95;
            box-sizing: border-box
        }

        .hidden-onplate {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 220ms ease, transform 220ms ease;
            pointer-events: none;
        }

        .controlsRow {
            display: flex;
            gap: 8px;
            align-items: center
        }

        select.countrySelect {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff
        }

        .note {
            font-size: 12px;
            color: #666;
            margin-top: 6px
        }

        @media (max-width:1000px) {
            :root {
                --plate-wrapper-size: 420px;
                --plate-diameter: 380px;
            }

            .sideColumn {
                right: 12px
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="topbar">
            <div style="display:flex;gap:12px;align-items:center">
                <button id="backBtn" class="btn">Back</button>
                <div style="color:#444">Compare your plate to recommended values and to country lunch estimates</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button id="resetAllBtn" class="btn">Reset</button>
            </div>
        </div>

        <div class="panels">
            <div class="panel">
                <div class="panelHeader">
                    <div class="panelTitle">Compare to Recommended (2000 kcal/day divided by 3 for lunch estimate)</div>
                    <div style="flex:1"></div>
                    <div class="controlsRow">
                        <button id="cmpRecommendedBtn" class="btn">Run Compare</button>
                        <button id="clearRecommendedBtn" class="btn">Clear</button>
                    </div>
                </div>

                <div class="canvasRow" style="position:relative">
                    <div class="plateCanvas" id="canvasRecommended">
                        <div class="layer" id="baseRecommended"></div>
                        <div class="layer" id="annulusRecommended"></div>
                        <div class="layer" id="overlayRecommended"></div>
                        <div class="sideColumn" id="sideRec"></div>
                    </div>

                    <div>
                        <div class="caption" id="captionRecommended">Press Run Compare to scale the plate to 2000
                            kcal/day (lunch ≈ 667 kcal.)</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panelHeader">
                    <div class="panelTitle">Compare to Reality</div>
                    <a href="https://ourworldindata.org/grapher/daily-per-capita-caloric-supply?tab=table&time=latest&country=GBR~FIN~Eastern+Asia+%28FAO%29~TZA" target="_blank">
                    Daily per capita caloric supply data. (Source for reality data)
                    </a>
                    <div style="flex:1"></div>
                    <div class="controlsRow">
                        <select id="countrySelect" class="countrySelect"></select>
                        <button id="cmpRealityBtn" class="btn">Compare to Country</button>
                        <button id="clearRealityBtn" class="btn">Clear</button>
                    </div>
                </div>

                <div class="canvasRow" style="position:relative">
                    <div class="plateCanvas" id="canvasReality">
                        <div class="layer" id="baseReality"></div>
                        <div class="layer" id="annulusReality"></div>
                        <div class="layer" id="overlayReality"></div>
                        <div class="sideColumn" id="sideReal"></div>
                    </div>

                    <div>
                        <div class="caption" id="captionReality">Choose a country and click Compare. Daily kcal (latest
                            year) ÷ 3 ≈ lunch estimate.</div>
                        <div class="note">Countries: Finland, Sweden, Norway, Denmark, United States, Canada, Brazil,
                            Argentina, Chile, China, India, Japan, Indonesia, Australia, New Zealand, Nigeria, Ethiopia,
                            Kenya, South Africa, Egypt, Morocco</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* CONFIG */
        const SESSION_KEY = 'plate_positions_fallback';
        const LOCAL_CSV = 'daily-per-capita-caloric-supply.csv';
        const LOCAL_META = 'daily-per-capita-caloric-supply.metadata.json';

        const CATALOG_IMG = {
            potato: 'images/potato.svg',
            sausage: 'images/sausage.svg',
            carrot: 'images/carrot.svg',
            bread_variant: 'images/cheese-bread.svg',
            bread: 'images/slice-of-bread.svg',
            'slice-of-bread': 'images/slice-of-bread.svg',
            'cheese-bread': 'images/cheese-bread.svg',
            'bread-with-butter': 'images/bread-with-butter.svg',
            apple: 'images/apple.svg',
            milk: 'images/milk-carton.svg',
            water: 'images/glass-of-water.svg'
        };

        const DEFAULT_GRAMS = { potato: 150, sausage: 75, carrot: 75, bread: 40, apple: 150, milk: 250, water: 200 };
        const COUNTRY_LIST = ["Finland", "Sweden", "Norway", "Denmark", "United States", "Canada", "Brazil", "Argentina", "Chile", "China", "India", "Japan", "Indonesia", "Australia", "New Zealand", "Nigeria", "Ethiopia", "Kenya", "South Africa", "Egypt", "Morocco"];

        let payload = null;
        let latestKcalByCountry = {};

        /* DOM refs */
        const countrySelect = document.getElementById('countrySelect');
        const baseRec = document.getElementById('baseRecommended');
        const annRec = document.getElementById('annulusRecommended');
        const overRec = document.getElementById('overlayRecommended');
        const sideRec = document.getElementById('sideRec');
        const capRec = document.getElementById('captionRecommended');

        const baseReal = document.getElementById('baseReality');
        const annReal = document.getElementById('annulusReality');
        const overReal = document.getElementById('overlayReality');
        const sideReal = document.getElementById('sideReal');
        const capReal = document.getElementById('captionReality');

        /* Utilities */
        function escapeAttr(s) { return String(s || '').replace(/"/g, '&quot;').replace(/</g, '&lt;'); }
        function resolveImageId(id) {
            if (!id) return 'images/unknown.svg';
            if (CATALOG_IMG[id]) return CATALOG_IMG[id];
            const norm = String(id).trim().toLowerCase().replace(/\s+/g, '-');
            if (CATALOG_IMG[norm]) return CATALOG_IMG[norm];
            return 'images/' + id + '.svg';
        }

        /* CSV parser */
        function parseCsv(text) {
            const rows = []; let cur = []; let curVal = ''; let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const ch = text[i], nxt = text[i + 1];
                if (ch === '"') { if (inQuotes && nxt === '"') { curVal += '"'; i++; continue; } inQuotes = !inQuotes; continue; }
                if (!inQuotes && (ch === '\n' || ch === '\r')) { if (ch === '\r' && text[i + 1] === '\n') i++; cur.push(curVal); rows.push(cur); cur = []; curVal = ''; continue; }
                if (!inQuotes && ch === ',') { cur.push(curVal); curVal = ''; continue; }
                curVal += ch;
            }
            if (curVal !== '' || cur.length) cur.push(curVal);
            if (cur.length) rows.push(cur);
            if (!rows.length) return { header: [], rows: [] };
            const header = rows[0].map(h => h.trim());
            const data = rows.slice(1).map(r => { const obj = {}; for (let j = 0; j < header.length; j++) obj[header[j]] = r[j] !== undefined ? r[j] : ''; return obj; });
            return { header, rows: data };
        }

        /* Load OWID, fallback, and add lowest-country option */
        async function loadLocalOwid() {
            latestKcalByCountry = {};
            try {
                const [metaRes, csvRes] = await Promise.all([fetch(LOCAL_META), fetch(LOCAL_CSV)]);
                if (!metaRes.ok || !csvRes.ok) throw new Error('fetch failed');
                const meta = await metaRes.json();
                const csvText = await csvRes.text();
                const parsed = parseCsv(csvText);
                const countryCol = parsed.header.find(h => /country|entity|name/i.test(h)) || parsed.header[0];
                const yearCol = parsed.header.find(h => /year/i.test(h)) || parsed.header[1];

                let valueCol = null;
                if (meta && meta.variables && Array.isArray(meta.variables)) {
                    const candidate = meta.variables.find(v => v.dataColumn || v.column || v.name);
                    if (candidate) valueCol = candidate.dataColumn || candidate.column || candidate.name;
                }
                if (!valueCol) {
                    const lc = parsed.header.map(h => h.toLowerCase());
                    const candidates = ['daily supply of calories per person', 'daily-per-capita-caloric-supply', 'value', 'daily supply', 'calories'];
                    for (const c of candidates) { const idx = lc.findIndex(h => h.includes(c)); if (idx !== -1) { valueCol = parsed.header[idx]; break; } }
                }
                if (!valueCol && parsed.rows.length) {
                    const sample = parsed.rows[0];
                    for (const k of Object.keys(sample)) { if (k === countryCol || k === yearCol) continue; const v = sample[k]; if (v !== '' && !isNaN(Number(v))) { valueCol = k; break; } }
                }

                const byCountry = {};
                parsed.rows.forEach(r => {
                    const country = (r[countryCol] || '').trim(); const year = Number(r[yearCol]);
                    const v = valueCol ? (r[valueCol] === '' ? NaN : Number(r[valueCol])) : NaN;
                    if (!country || !year || isNaN(v)) return;
                    if (!byCountry[country]) byCountry[country] = {};
                    byCountry[country][year] = v;
                });

                COUNTRY_LIST.forEach(c => {
                    const data = byCountry[c];
                    if (!data) { latestKcalByCountry[c] = null; return; }
                    const yrs = Object.keys(data).map(Number).filter(y => !isNaN(y));
                    if (!yrs.length) { latestKcalByCountry[c] = null; return; }
                    const latest = Math.max(...yrs);
                    latestKcalByCountry[c] = { year: latest, kcal: data[latest] };
                });

                addLowestCountryOption();
                return true;
            } catch (e) {
                console.warn('loadLocalOwid failed; using fallback', e);
                const fallback = { "Finland": 3360, "Sweden": 3300, "Norway": 3350, "Denmark": 3250, "United States": 3800, "Canada": 3650, "Brazil": 2850, "Argentina": 2950, "Chile": 3000, "China": 3000, "India": 2400, "Japan": 2700, "Indonesia": 2600, "Australia": 3400, "New Zealand": 3500, "Nigeria": 2000, "Ethiopia": 2000, "Kenya": 2100, "South Africa": 2600, "Egypt": 2500, "Morocco": 2400 };
                COUNTRY_LIST.forEach(c => { if (fallback[c]) latestKcalByCountry[c] = { year: 2022, kcal: fallback[c] }; else latestKcalByCountry[c] = null; });
                addLowestCountryOption();
                return false;
            }
        }
        function addLowestCountryOption() {
            let minCountry = null, minVal = Infinity, minYear = null;
            Object.keys(latestKcalByCountry).forEach(c => {
                const info = latestKcalByCountry[c];
                if (info && typeof info.kcal === 'number' && info.kcal < minVal) { minVal = info.kcal; minCountry = c; minYear = info.year; }
            });
            populateCountrySelect(minCountry, minVal, minYear);
        }
        function populateCountrySelect(lowestCountry, lowestVal, lowestYear) {
            countrySelect.innerHTML = '';
            COUNTRY_LIST.forEach(c => {
                const info = latestKcalByCountry[c];
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = info && info.kcal ? `${c} — ${Math.round(info.kcal)} kcal/day (${info.year})` : `${c} — (no data)`;
                countrySelect.appendChild(opt);
            });
            if (lowestCountry) {
                const sep = document.createElement('option'); sep.disabled = true; sep.textContent = '──────────────';
                countrySelect.appendChild(sep);
                const opt = document.createElement('option');
                opt.value = lowestCountry;
                opt.textContent = `Lowest: ${lowestCountry} — ${Math.round(lowestVal)} kcal/day (${lowestYear})`;
                opt.dataset.lowest = '1';
                countrySelect.appendChild(opt);
            }
        }

        /* HALF clipping helper */
        function applyHalfClass(imgEl, fraction, rotationDeg) {
            if (!imgEl) return;
            imgEl.classList.remove('clip-half-left', 'clip-half-right');
            if (typeof fraction !== 'number') return;
            if (Math.abs(fraction - 0.5) < 0.011) {
                const rad = (rotationDeg || 0) * Math.PI / 180;
                const dx = Math.cos(rad);
                if (dx < 0) imgEl.classList.add('clip-half-right'); else imgEl.classList.add('clip-half-left');
            }
        }

        /* Fraction-based visual scaling only when fraction clearly < 0.49 */
        function applyFractionScaleIfNeeded(imgEl, fraction) {
            if (!imgEl) return;
            imgEl.style.transform = '';
            if (typeof fraction === 'number' && fraction < 0.49) {
                const s = Math.max(0.25, Math.min(1, fraction));
                imgEl.style.transform = `scale(${s})`;
            }
        }

        /* Side slots */
        function computeSideSlots(canvasEl) {
            const rect = canvasEl.getBoundingClientRect();
            const plateDiameter = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--plate-diameter')) || 480;
            const plateRight = (rect.width / 2) + (plateDiameter / 2);
            const gap = Math.max(8, Math.round(Math.min(rect.width, rect.height) * 0.02));
            const columnX = Math.min(rect.width - 30, Math.round(plateRight + gap));
            const startY = 40; const spacing = 18 + 86;
            const slots = []; const max = Math.max(4, Math.floor((rect.height - startY - 20) / spacing));
            for (let i = 0; i < max; i++) slots.push({ x: columnX, y: startY + i * spacing });
            return slots;
        }

        /* Render base (onplate + side) */
        function renderBase(targetBase, sideContainer) {
            targetBase.innerHTML = ''; sideContainer.innerHTML = '';
            const wrap = document.createElement('div'); wrap.className = 'plateWrap';
            const inner = document.createElement('div'); inner.className = 'plateInner';
            wrap.appendChild(inner); targetBase.appendChild(wrap);
            const slots = computeSideSlots(targetBase.parentElement);

            (payload.positions || []).forEach(p => {
                const fraction = (typeof p.fraction === 'number') ? p.fraction : (p.gramsPerPortion ? p.grams / p.gramsPerPortion : 1);

                if (p.placement === 'side') {
                    const idx = (typeof p.sideSlot === 'number') ? p.sideSlot : 0;
                    const chosen = slots[Math.min(idx, slots.length - 1)] || { x: targetBase.parentElement.clientWidth - 100, y: 40 };
                    const si = document.createElement('div'); si.className = 'sideItem'; si.style.position = 'absolute';
                    si.style.left = (chosen.x - 40) + 'px'; si.style.top = (chosen.y - 20) + 'px';
                    const src = p._imgOverride || resolveImageId(p.id);
                    const img = document.createElement('img'); img.src = src; img.alt = p.label || p.id || ''; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'contain';
                    applyHalfClass(img, fraction, p.rotationDeg || 0);
                    applyFractionScaleIfNeeded(img, fraction);
                    si.appendChild(img);
                    sideContainer.appendChild(si);
                    return;
                }

                const w = document.createElement('div'); w.className = 'itemWrapper'; w.dataset.onplate = '1';
                w.style.position = 'absolute'; w.style.left = (p.x || 0) + 'px'; w.style.top = (p.y || 0) + 'px';
                w.style.width = (p.sizePx || 48) + 'px'; w.style.height = (p.sizePx || 48) + 'px';
                w.style.transform = `translate(-50%,-50%) rotate(${p.rotationDeg || 0}deg)`;
                const img = document.createElement('img'); img.src = p._imgOverride || resolveImageId(p.id); img.alt = p.label || p.id || '';
                applyHalfClass(img, fraction, p.rotationDeg || 0);
                applyFractionScaleIfNeeded(img, fraction);
                w.appendChild(img); inner.appendChild(w);
            });
        }

        /* Build overlay groups */
        function buildOverlay(targetOverlay) {
            targetOverlay.innerHTML = '';
            const wrap = document.createElement('div'); wrap.className = 'plateWrap';
            const ghost = document.createElement('div'); ghost.className = 'ghostGroup';
            const scaled = document.createElement('div'); scaled.className = 'scaledGroup';
            const ghostInner = document.createElement('div'); ghostInner.className = 'ghostInnerGroup';

            (payload.positions || []).forEach(p => {
                if (p.placement !== 'onplate') return;
                const fraction = (typeof p.fraction === 'number') ? p.fraction : (p.gramsPerPortion ? p.grams / p.gramsPerPortion : 1);
                const sizePx = p.sizePx || 48;

                const gw = document.createElement('div'); gw.className = 'itemWrapper';
                gw.style.position = 'absolute'; gw.style.left = (p.x || 0) + 'px'; gw.style.top = (p.y || 0) + 'px';
                gw.style.width = sizePx + 'px'; gw.style.height = sizePx + 'px';
                gw.style.transform = `translate(-50%,-50%) rotate(${p.rotationDeg || 0}deg)`;
                const gimg = document.createElement('img'); gimg.src = p._imgOverride || resolveImageId(p.id); gimg.alt = p.label || p.id || '';
                gimg.className = 'ghost-img'; applyHalfClass(gimg, fraction, p.rotationDeg || 0); applyFractionScaleIfNeeded(gimg, fraction);
                gw.appendChild(gimg); ghost.appendChild(gw);

                const sw = document.createElement('div'); sw.className = 'itemWrapper';
                sw.style.position = 'absolute'; sw.style.left = (p.x || 0) + 'px'; sw.style.top = (p.y || 0) + 'px';
                sw.style.width = sizePx + 'px'; sw.style.height = sizePx + 'px';
                sw.dataset.rotate = (p.rotationDeg || 0);
                sw.style.transform = `translate(-50%,-50%) rotate(${p.rotationDeg || 0}deg) scale(1)`;
                const simg = document.createElement('img'); simg.src = p._imgOverride || resolveImageId(p.id); simg.alt = p.label || p.id || '';
                simg.className = 'scaled-img'; applyHalfClass(simg, fraction, p.rotationDeg || 0); applyFractionScaleIfNeeded(simg, fraction);
                sw.appendChild(simg); scaled.appendChild(sw);

                const giw = document.createElement('div'); giw.className = 'itemWrapper';
                giw.style.position = 'absolute'; giw.style.left = (p.x || 0) + 'px'; giw.style.top = (p.y || 0) + 'px';
                giw.style.width = sizePx + 'px'; giw.style.height = sizePx + 'px';
                const innerScale = 0.72;
                giw.style.transform = `translate(-50%,-50%) rotate(${p.rotationDeg || 0}deg) scale(${innerScale})`;
                const giimg = document.createElement('img'); giimg.src = p._imgOverride || resolveImageId(p.id); giimg.alt = p.label || p.id || '';
                giimg.className = 'ghost-inner-img'; applyHalfClass(giimg, fraction, p.rotationDeg || 0);
                if (fraction < 0.49) giimg.style.transform = `scale(${innerScale * Math.max(0.25, Math.min(1, fraction))})`;
                giw.appendChild(giimg); ghostInner.appendChild(giw);
            });

            wrap.appendChild(ghost); wrap.appendChild(scaled); wrap.appendChild(ghostInner);
            targetOverlay.appendChild(wrap);

            targetOverlay._wrap = wrap;
            targetOverlay._ghost = ghost;
            targetOverlay._scaled = scaled;
            targetOverlay._ghostInner = ghostInner;
        }

        /* Annulus drawing */
        function drawAnnulus(node, scale) {
            node.innerHTML = '';
            if (!scale || isNaN(scale)) return;
            const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--plate-diameter')) || 480;
            const scaled = Math.max(2, Math.round(base * scale));
            if (scale >= 1) {
                const ann = document.createElement('div'); ann.className = 'annulus';
                ann.style.position = 'absolute'; ann.style.left = '50%'; ann.style.top = '50%'; ann.style.transform = 'translate(-50%,-50%)';
                ann.style.boxSizing = 'border-box';
                const outer = scaled; const thickness = Math.max(4, Math.round((scaled - base) / 2));
                ann.style.width = outer + 'px'; ann.style.height = outer + 'px';
                ann.style.border = `${thickness}px solid rgba(88,196,104,0.95)`; node.appendChild(ann);
            } else {
                const fill = document.createElement('div'); fill.className = 'overlayFill';
                fill.style.width = scaled + 'px'; fill.style.height = scaled + 'px';
                fill.style.background = 'rgba(220,70,70,0.22)'; fill.style.border = '1px solid rgba(220,70,70,0.28)';
                fill.style.left = '50%'; fill.style.top = '50%'; fill.style.position = 'absolute'; fill.style.transform = 'translate(-50%,-50%)';
                fill.style.boxSizing = 'border-box'; node.appendChild(fill);
                const rim = document.createElement('div'); rim.className = 'annulus';
                rim.style.position = 'absolute'; rim.style.left = '50%'; rim.style.top = '50%'; rim.style.transform = 'translate(-50%,-50%)';
                rim.style.boxSizing = 'border-box';
                const outer = scaled; const thickness = Math.max(2, Math.round(outer * 0.02));
                rim.style.width = outer + 'px'; rim.style.height = outer + 'px';
                rim.style.border = `${thickness}px solid rgba(220,70,70,0.22)`; node.appendChild(rim);
            }
        }

        /* Calories mapping */
        const CAL_PER_G = { potato: 0.77, sausage: 2.5, carrot: 0.41, bread_variant: 2.5, bread: 2.5, apple: 0.52, milk: 0.64, water: 0.0 };
        const avgKcalPerGram = 1.5;
        function kcalToGrams(kcal) { return Math.max(0, Math.round(kcal / avgKcalPerGram)); }
        function buildTargetGramsMap(totalGrams) {
            const idsPreferred = ['potato', 'carrot', 'bread_variant', 'sausage', 'apple', 'milk'];
            const weights = [1.3, 1, 1.1, 0.9, 0.9, 1.0];
            const totalW = weights.reduce((s, w) => s + w, 0);
            const map = {}; let remaining = totalGrams;
            idsPreferred.forEach((id, i) => { const g = Math.round((weights[i] / totalW) * totalGrams); map[id] = g; remaining -= g; });
            let i = 0; while (remaining > 0) { const key = idsPreferred[i % idsPreferred.length]; map[key] = (map[key] || 0) + 1; remaining--; i++; }
            return map;
        }
        function totalCaloriesFromMap(map) { let sum = 0; Object.keys(map || {}).forEach(id => { const grams = map[id] || 0; const calPerG = CAL_PER_G[id] !== undefined ? CAL_PER_G[id] : 0.8; sum += grams * calPerG; }); return sum; }
        function totalCaloriesPayloadFromPositions(positions) { return (positions || []).reduce((s, p) => { if (typeof p.kcalPerPortion === 'number' && typeof p.gramsPerPortion === 'number' && p.gramsPerPortion > 0) { const calPerG = p.kcalPerPortion / p.gramsPerPortion; return s + (p.grams || 0) * calPerG; } const calPerG = CAL_PER_G[p.id] !== undefined ? CAL_PER_G[p.id] : 0.8; return s + (p.grams || 0) * calPerG; }, 0); }
        function totalCaloriesPayload() { if (payload && typeof payload.totalCalories === 'number') return Math.max(0, Math.round(payload.totalCalories)); return Math.max(0, Math.round(totalCaloriesPayloadFromPositions(payload.positions || []))); }
        function computeScaleFromCalories(targetMap) { const actual = Math.max(1, totalCaloriesPayload()); const target = Math.max(0, totalCaloriesFromMap(targetMap || {})); if (target <= 0) return 0.001; return Math.max(0.12, Math.min(3.0, Math.sqrt(target / actual))); }

        function placeSideColumn(sideContainer, toRight) { if (!sideContainer) return; sideContainer.classList.remove('left'); if (!toRight) sideContainer.classList.add('left'); }

        function renderSideOnly(sideContainer, targetBase) {
            sideContainer.innerHTML = '';
            const slots = computeSideSlots(targetBase.parentElement);
            (payload.positions || []).forEach(p => {
                if (p.placement !== 'side') return;
                const idx = (typeof p.sideSlot === 'number') ? p.sideSlot : 0;
                const chosen = slots[Math.min(idx, slots.length - 1)] || { x: targetBase.parentElement.clientWidth - 100, y: 40 };
                const si = document.createElement('div'); si.className = 'sideItem'; si.style.position = 'absolute';
                si.style.left = (chosen.x - 40) + 'px'; si.style.top = (chosen.y - 20) + 'px';
                const src = p._imgOverride || resolveImageId(p.id);
                const img = document.createElement('img'); img.src = src; img.alt = p.label || p.id || ''; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'contain';
                const fraction = (typeof p.fraction === 'number') ? p.fraction : (p.gramsPerPortion ? p.grams / p.gramsPerPortion : 1);
                applyHalfClass(img, fraction, p.rotationDeg || 0);
                applyFractionScaleIfNeeded(img, fraction);
                si.appendChild(img); sideContainer.appendChild(si);
            });
        }

        function runCompare(targetOverlay, targetBase, annNode, sideContainer, captionEl, targetMap, isReality) {
            if (!payload) { alert('No saved plate found in sessionStorage under key: ' + SESSION_KEY); return; }
            targetOverlay.innerHTML = ''; annNode.innerHTML = ''; sideContainer.innerHTML = '';
            buildOverlay(targetOverlay); renderSideOnly(sideContainer, targetBase);

            const scale = computeScaleFromCalories(targetMap);
            const wrap = targetBase.querySelector('.plateWrap');
            if (wrap) { wrap.style.transition = 'transform 700ms cubic-bezier(.2,.9,.2,1)'; requestAnimationFrame(() => wrap.style.transform = `translate(-50%,-50%) scale(${scale})`); }
            drawAnnulus(annNode, scale);

            Array.from(targetBase.querySelectorAll('.itemWrapper')).forEach(el => { if (el.dataset.onplate === '1') el.classList.add('hidden-onplate'); });

            const ghostGroup = targetOverlay._ghost;
            const scaledGroup = targetOverlay._scaled;
            const ghostInnerGroup = targetOverlay._ghostInner;
            if (!ghostGroup || !scaledGroup || !ghostInnerGroup) return;

            ghostGroup.style.display = '';
            scaledGroup.style.display = '';
            ghostInnerGroup.style.display = '';

            if (scale < 1) {
                ghostInnerGroup.style.display = 'none';
                ghostGroup.style.opacity = '0.65';
                Array.from(scaledGroup.querySelectorAll('.itemWrapper')).forEach(sw => {
                    const rotate = Number(sw.dataset.rotate || 0);
                    sw.style.transition = 'transform 700ms cubic-bezier(.2,.9,.2,1)';
                    requestAnimationFrame(() => sw.style.transform = `translate(-50%,-50%) rotate(${rotate}deg) scale(${scale})`);
                });
            } else {
                ghostGroup.style.opacity = '0.35';
                ghostInnerGroup.style.display = '';
                Array.from(scaledGroup.querySelectorAll('.itemWrapper')).forEach(sw => {
                    const rotate = Number(sw.dataset.rotate || 0);
                    sw.style.transition = 'transform 700ms cubic-bezier(.2,.9,.2,1)';
                    requestAnimationFrame(() => sw.style.transform = `translate(-50%,-50%) rotate(${rotate}deg) scale(${scale})`);
                });
                Array.from(ghostInnerGroup.querySelectorAll('.itemWrapper')).forEach(giw => { giw.style.transition = 'opacity 300ms ease'; giw.style.opacity = '1'; });
            }

            const actualCal = Math.round(totalCaloriesPayload());
            const targetCal = Math.round(totalCaloriesFromMap(targetMap || {}));
            placeSideColumn(sideContainer, targetCal >= actualCal);

            setTimeout(() => {
                let diffPct = 0;
                if (actualCal > 0) diffPct = Math.round(((targetCal - actualCal) / actualCal) * 100);
                else diffPct = targetCal > 0 ? 100 : 0;
                if (isReality) {
                    if (diffPct < 0) captionEl.textContent = `This country average lunch is ${Math.abs(diffPct)}% lower than your plate`;
                    else if (diffPct > 0) captionEl.textContent = `This country average lunch is ${diffPct}% higher than your plate`;
                    else captionEl.textContent = 'This country average lunch is equal to your plate';
                } else {
                    if (diffPct < 0) captionEl.textContent = `Recommendation is ${Math.abs(diffPct)}% lower than your plate`;
                    else if (diffPct > 0) captionEl.textContent = `Recommendation is ${diffPct}% higher than your plate`;
                    else captionEl.textContent = 'Recommendation matches your plate';
                }
            }, 700);
        }

        /* Clear helper */
        function clearCompare(targetOverlay, targetBase, annNode, sideContainer, captionEl) {
            targetOverlay.innerHTML = ''; annNode.innerHTML = ''; sideContainer.innerHTML = '';
            const wrap = targetBase.querySelector('.plateWrap');
            if (wrap) { wrap.style.transition = 'transform 300ms ease'; wrap.style.transform = 'translate(-50%,-50%) scale(1)'; }
            Array.from(targetBase.querySelectorAll('.itemWrapper')).forEach(el => { if (el.dataset.onplate === '1') el.classList.remove('hidden-onplate'); });
            captionEl.textContent = 'Comparison cleared.';
        }

        /* UI wiring */
        document.getElementById('backBtn').addEventListener('click', () => history.back());
        document.getElementById('resetAllBtn').addEventListener('click', () => { clearCompare(overRec, baseRec, annRec, sideRec, capRec); clearCompare(overReal, baseReal, annReal, sideReal, capReal); });

        document.getElementById('cmpRecommendedBtn').addEventListener('click', () => {
            const recommendedDaily = 2000; 
            const lunchKcal = recommendedDaily / 3;
            const lunchGrams = kcalToGrams(lunchKcal);
            const recommendedMap = buildTargetGramsMap(lunchGrams);
            runCompare(overRec, baseRec, annRec, sideRec, capRec, recommendedMap, false);
        });
        document.getElementById('clearRecommendedBtn').addEventListener('click', () => clearCompare(overRec, baseRec, annRec, sideRec, capRec));
        document.getElementById('cmpRealityBtn').addEventListener('click', () => {
            const country = countrySelect.value;
            const info = latestKcalByCountry[country];
            if (!info || !info.kcal) { alert('No data for ' + country); return; }
            const dailyKcal = info.kcal; const lunchKcal = dailyKcal / 3; const lunchGrams = kcalToGrams(lunchKcal);
            const gramsMap = buildTargetGramsMap(lunchGrams);
            runCompare(overReal, baseReal, annReal, sideReal, capReal, gramsMap, true);
        });
        document.getElementById('clearRealityBtn').addEventListener('click', () => clearCompare(overReal, baseReal, annReal, sideReal, capReal));

        /* INIT: load payload from sessionStorage and OWID */
        (async function init() {
            try { const raw = sessionStorage.getItem(SESSION_KEY); if (raw) payload = JSON.parse(raw); } catch (e) { payload = null; }
            if (payload) {
                (payload.positions || []).forEach(item => {
                    if (typeof item.gramsPerPortion !== 'number') item.gramsPerPortion = item.gramsPerPortion || (DEFAULT_GRAMS[item.id] || 100);
                    if (!('grams' in item) || item.grams == null) item.grams = item.grams || 0;
                    if (item.gramsPerPortion && typeof item.grams === 'number') {
                        const rawf = item.grams / item.gramsPerPortion;
                        item.fraction = Number(Math.max(0, Math.min(1, rawf)).toFixed(3));
                    } else item.fraction = item.fraction || 1;
                });
                renderBase(baseRec, sideRec);
                renderBase(baseReal, sideReal);
            } else {
                baseRec.innerHTML = ''; baseReal.innerHTML = '';
                capRec.textContent = 'No saved plate in sessionStorage under key: ' + SESSION_KEY;
                capReal.textContent = 'No saved plate in sessionStorage under key: ' + SESSION_KEY;
            }

            await loadLocalOwid();
        })();
    </script>
</body>

</html>
